{% load static %}
<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TSP Cooperative Web Interface</title>
  <link href="{% static 'style.css' %}" rel="stylesheet">

  <style>
    header nav {
      /* just to position your nav in the top-left corner */
      position: fixed;
      top: 1rem;
      left: 1rem;
      z-index: 1000;
    }

    header nav a {
      display: inline-block;
      padding: 0.5rem 1rem;
      margin-right: 0.5rem;
      background-color: #4f46e5;
      /* Bleu vif */
      color: #fff;
      font-weight: 600;
      text-decoration: none;
      border-radius: 9999px;
      /* full pill */
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
      transition: background-color 0.2s ease, transform 0.1s ease;
    }

    header nav a:hover {
      background-color: #4338ca;
      /* Slightly darker on hover */
      transform: translateY(-1px);
    }

    header nav a:active {
      background-color: #3730a3;
      /* Even darker when clicked */
      transform: translateY(0);
    }
  </style>
</head>

<body>
  <img id="bg" src="{% static 'bg.jpg' %}" alt="">
  <header>
    <nav>
      <a href="{% url 'home_app:home_app' %}">Home</a>
      <!-- <a href="{% url 'home_app:meta_heuristics' %}">Méta-heuristiques</a> -->
    </nav>
  </header>

  <div class="container"><!-- only one container -->

    <!-- Form card -->
    <div class="card">
      <h1>TSP Cooperative Solver</h1>
      <form id="configForm" method="post">
        <input type="hidden" name="algo" value="{{ algo }}">
        <div>
          <label for="filename">benchmark files</label>
          <!-- <input type="text" id="filename" name="filename" value="berlin52_coords.txt" /> -->
          <select name="filename">
            <option value="berlin52_coords.txt">Berlin52</option>
            <option value="pr76_coords.txt">pr76</option>
            <option value="rat99_coords.txt">rat99</option>
            <option value="krA100_coords.txt">krA100</option>
            <option value="krB100_coords.txt">krB100</option>
            <option value="pr107_coords.txt">pr107</option>
            <option value="pr124_coords.txt">pr124</option>
            <option value="pr136_coords.txt">pr136</option>
            <option value="pr144_coords.txt">pr144</option>
            <option value="ch150_coords.txt">ch150</option>
            <option value="krB150_coords.txt">krB150</option>
            <option value="pr152_coords.txt">pr152</option>
            <option value="rat195_coords.txt">rat195</option>
            <option value="pr226_coords.txt">pr226</option>
            <option value="pr264_coords.txt">pr264</option>
            <option value="pr299_coords.txt">pr299</option>
            <option value="pr439_coords.txt">pr439</option>
          </select>
        </div>
        <div>
          <label for="POP_SIZE">POP_SIZE</label>
          <input type="number" id="POP_SIZE" name="POP_SIZE" value="50" required min="1" step="1" />
          <span class="error-message"></span>
        </div>
        <div>
          <label for="NUM_GENERATIONS">Generations</label>
          <input type="number" id="NUM_GENERATIONS" name="NUM_GENERATIONS" value="500" required min="1" step="1" />
          <span class="error-message"></span>
        </div>
        <div>
          <label for="MUTATION_RATE">MUTATION_RATE</label>
          <input type="number" step="0.01" id="MUTATION_RATE" name="MUTATION_RATE" value="0.2" required min="0" max="1"
            step="0.01" />
          <span class="error-message"></span>
        </div>

        <!-- Paramètres ACO -->
        <div>
          <label for="ALPHA">Alpha (ACO)</label>
          <input type="number" step="0.1" id="ALPHA" name="ALPHA" value="1" required min="0.5" max="2" step="0.01" />
          <span class="error-message"></span>
        </div>
        <div>
          <label for="BETA">Beta (ACO)</label>
          <input type="number" step="0.1" id="BETA" name="BETA" value="3" required min="2" max="5" step="0.01" />
          <span class="error-message"></span>
        </div>
        <div>
          <label for="EVAPORATION_RATE">EVAPORATION_RATE (ACO)</label>
          <input type="number" step="0.01" id="EVAPORATION_RATE" name="EVAPORATION_RATE" value="0.1" required min="0.1"
            max="0.99" step="0.01" />
          <span class="error-message"></span>
        </div>
        <div>
          <label for="Q">Q Value (ACO)</label>
          <input type="number" id="Q" name="Q" value="100" required min="1" step="1" />
          <span class="error-message"></span>
        </div>
        <!-- Nouveaux paramètres SA et HBC -->
        <div>
          <label for="SA_T">SA Initial Temperature (SA_T)</label>
          <input type="number" id="SA_T" name="SA_T" value="50.0" required min="0.1" step="0.1" />
          <span class="error-message"></span>
        </div>
        <div>
          <label for="SA_COOLING">SA Cooling Factor (SA_COOLING)</label>
          <input type="number" id="SA_COOLING" name="SA_COOLING" value="0.995" required min="0.5" max="1"
            step="0.001" />
          <span class="error-message"></span>
        </div>
        <div>
          <label for="NUM_BEES">
            Number of bees in each iteration</label>
          <input type="number" id="NUM_BEES" name="NUM_BEES" value="20" required min="1" step="1" />
          <span class="error-message"></span>
        </div>
        <div>
          <label for="MAX_ITER">Iterations (beehive)</label>
          <input type="number" id="MAX_ITER" name="MAX_ITER" value="50" required min="1" step="1" />
          <span class="error-message"></span>
        </div>
        <button type="submit">Run solver</button>
        <!-- <button type="button" id="compareButton">Comparer</button> -->
      </form>
    </div>

    <!-- Results card -->
    <div id="results" class="card hidden">
      <!-- Convergence & erreur charts -->
      <div>
        <h2>Convergence</h2>
        <canvas id="convergenceChart"></canvas>
      </div>
      <div>
        <h2>Relative Error (%)</h2>
        <canvas id="errorChart"></canvas>
      </div>
      <pre id="logConsole"></pre>

      <!-- Meilleur tour (initialement caché) -->
      <div id="bestTour" class="full-width hidden">
        <h2>Best tour</h2>
        <p id="bestTourText"></p>
      </div>

      <!-- Trace du tour (initialement cachée) -->
      <div id="pathContainer" class="full-width hidden">
        <h2>Tour path</h2>
        <canvas id="pathChart"></canvas>
      </div>
    </div>

  </div><!-- /container -->

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

  <script>
    // Récupère la valeur d’un cookie
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        document.cookie.split(';').forEach(cookie => {
          const [key, val] = cookie.trim().split('=');
          if (key === name) cookieValue = decodeURIComponent(val);
        });
      }
      return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    document.addEventListener("DOMContentLoaded", () => {
      const form = document.getElementById("configForm");
      const compareButton = document.getElementById("compareButton");
      const results = document.getElementById("results");
      const logConsole = document.getElementById("logConsole");
      const bestTourEl = document.getElementById("bestTour");
      const bestTourText = document.getElementById("bestTourText");
      const pathContainer = document.getElementById("pathContainer");
      const pathCtx = document.getElementById("pathChart").getContext("2d");

      let pathChart;
      let distChart, errChart;
      let lastGen = 0;
      let pollInterval;

      function showError(input, message) {
        input.classList.add("error");
        const msgSpan = input.nextElementSibling;
        msgSpan.textContent = message;
      }

      // helper to clear previous errors
      function clearErrors() {
        form.querySelectorAll("input, select").forEach(el => {
          el.classList.remove("error");
          const msg = el.nextElementSibling;
          if (msg && msg.classList.contains("error-message")) {
            msg.textContent = "";
          }
        });
      }



      // 🟢 RESET FUNCTION
      function restartAll() {
        results.classList.add("hidden");
        bestTourEl.classList.add("hidden");
        pathContainer.classList.add("hidden");
        logConsole.textContent = "";
        bestTourText.textContent = "";
        lastGen = 0;
        if (pollInterval) {
          clearInterval(pollInterval);
          pollInterval = null;
        }
        if (distChart) {
          distChart.destroy();
          distChart = null;
        }
        if (errChart) {
          errChart.destroy();
          errChart = null;
        }
        if (pathChart) {
          pathChart.destroy();
          pathChart = null;
        }
        document.getElementById("convergenceChart").getContext("2d").clearRect(0, 0, 400, 400);
        document.getElementById("errorChart").getContext("2d").clearRect(0, 0, 400, 400);
        document.getElementById("pathChart").getContext("2d").clearRect(0, 0, 400, 400);
      }

      // 🟢 On form submit
      form.addEventListener("submit", async (e) => {

        clearErrors();

        // 2) On valide tous les inputs number
        let valid = true;
        form.querySelectorAll('input[type="number"]').forEach(input => {
          const val = input.value.trim();
          const min = parseFloat(input.getAttribute('min') || '0');

          // champ vide ?
          if (!val) {
            valid = false;
            showError(input, "This field is required.");
            return;
          }
          // nombre valide ?
          const num = parseFloat(val);
          if (isNaN(num)) {
            valid = false;
            showError(input, "Please enter a valid number.");
            return;
          }
          // respect du min ?
          if (num < min) {
            valid = false;
            showError(input, `The value must be≥ ${min}.`);
            return;
          }
        });

        // 3) Si on a trouvé une erreur, on stoppe tout
        if (!valid) {
          e.preventDefault();
          return;
        }





        e.preventDefault();
        restartAll();

        // Récupération des paramètres
        const data = {};
        new FormData(form).forEach((value, key) => {
          data[key] = isNaN(value) ? value : +value;
        });

        // Démarrage du job
        const startRes = await fetch("{% url 'tsp_app:solver' %}", {
          method: "POST",
          credentials: "same-origin",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": csrftoken
          },
          body: JSON.stringify(data)
        });

        if (!startRes.ok) {
          console.error("Échec démarrage job:", await startRes.text());
          return;
        }

        // 🔽 Récupération du job_id depuis la réponse JSON
        const startData = await startRes.json();
        const job_id = startData.job_id;

        results.classList.remove("hidden");
        logConsole.textContent = "";
        lastGen = 0;

        // Initialisation des graphiques Chart.js
        const ctxD = document.getElementById("convergenceChart").getContext("2d");
        distChart = new Chart(ctxD, {
          type: "line",
          data: {
            labels: [],
            datasets: [{
              label: "Distance",
              data: [],
              fill: false
            }]
          },
          options: {
            responsive: true,
            scales: {
              x: { title: { display: true, text: "Génération" } },
              y: { title: { display: true, text: "Distance" } }
            }
          }
        });

        const ctxE = document.getElementById("errorChart").getContext("2d");
        errChart = new Chart(ctxE, {
          type: "line",
          data: {
            labels: [],
            datasets: [{
              label: "Error (%)",
              data: [],
              fill: false
            }]
          },
          options: {
            responsive: true,
            scales: {
              x: { title: { display: true, text: "Génération" } },
              y: { title: { display: true, text: "Error (%)" } }
            }
          }
        });

        // Lancement du polling avec le job_id
        pollInterval = setInterval(async () => {
          // 🔽 Ajout du job_id dans la requête GET
          const statusRes = await fetch(`{% url 'tsp_app:result' %}?job_id=${encodeURIComponent(job_id)}`, {
            credentials: "same-origin"
          });

          const job = await statusRes.json();
          console.log("🔄 Status du job :", job);

          if (job.logs && job.logs.length > lastGen) {
            const newLogs = job.logs.slice(lastGen);
            newLogs.forEach(entry => {
              console.log(`📈 Gén ${entry.gen}`, entry);
              distChart.data.labels.push(entry.gen);
              distChart.data.datasets[0].data.push(entry.distance);
              errChart.data.labels.push(entry.gen);
              errChart.data.datasets[0].data.push(entry.error);
              logConsole.textContent +=
                `Gen ${entry.gen} | Dist: ${entry.distance} | Err: ${entry.error}% | Time: ${entry.temps}s | Totaltime: ${entry.temps_total}s\n`;
              logConsole.scrollTop = logConsole.scrollHeight;
            });
            distChart.update();
            errChart.update();
            lastGen = job.logs.length;
          }

          if (job.status === "done" || job.status === "error") {
            clearInterval(pollInterval);


            if (job.status === "done") {
              bestTourEl.classList.remove("hidden");
              const fullTour = [...job.tour, job.tour[0]];
              bestTourText.textContent = fullTour.join(" → ");

              const tourCoords = fullTour.map(idx => ({
                x: job.city_coords[idx][0],
                y: job.city_coords[idx][1]
              }));
              tourCoords.push(tourCoords[0]);
              const startPoint = [tourCoords[0]];
              pathContainer.classList.remove("hidden");

              if (!pathChart) {
                pathChart = new Chart(pathCtx, {
                  type: "scatter",
                  data: {
                    datasets: [
                      {
                        label: "Tour",
                        data: tourCoords,
                        showLine: true,
                        fill: false,
                        borderColor: "#2563eb",
                        pointRadius: 4,
                        pointBackgroundColor: "#2563eb"
                      },
                      {
                        label: "Start",
                        data: startPoint,
                        showLine: false,
                        pointRadius: 8,
                        pointBackgroundColor: "red"
                      }
                    ]
                  },
                  options: {
                    responsive: true,
                    scales: {
                      x: { type: "linear", title: { display: true, text: "X" } },
                      y: { type: "linear", title: { display: true, text: "Y" } }
                    }
                  }
                });
              } else {
                pathChart.data.datasets[0].data = tourCoords;
                pathChart.update();
              }
              console.log("🖼️ pathChart instance:", pathChart);
              console.log("✅ Affichage du chemin, pathContainer classes:", pathContainer.classList);
              if (!logConsole.textContent.includes("✅ Execution completed")) {
                logConsole.textContent += "\n✅ Execution completed\n";
                logConsole.scrollTop = logConsole.scrollHeight;
              }


              return;
            }

            if (job.status === "error") {
              logConsole.textContent += `\nErreur serveur : ${job.error_msg}\n`;
            }
          }
        }, 250);
      });

      // 🟢 Compare button reset
      compareButton.addEventListener("click", () => {
        restartAll();
        // Ajoutez ici la logique de comparaison si besoin
      });

    });

  </script>

</body>


</html>